---
title: "Part II 電腦作業"
output: html_notebook     
---
作業題目有些LaTex數學式，你可以按RStudio上方的Preview來呈現完整的數學符號。

在勞動經濟學中，我們經常關注各種因素對於工資的影響，其中一項是加入工會對於薪資的影響。

首先請先執行以下程式，清空環境並引入Panel分析的套件plm。
```{r, message=FALSE, warning=FALSE}
rm(list=ls())
library(plm)
library(readr)
library(dplyr)
```


1. 引入WAGEPAN.rda這個資料。
```{r}
load("~/Part-II-Assignment/WAGEPAN.rdata")
wage_data<-WAGEPAN
```

在WAGEPAN.rda這個資料中，nr代表某個勞動者，year代表資料所來自年份

2. 請定義資料成為panel data，並取名WAGE_data。
```{r}
wage_data<-pdata.frame(wage_data,c("nr","year"))
```

***
以下分析皆以WAGE_data為主

3. 使用str()檢查nr及year兩個變數的class, 並使用levels()來查看資料橫跨年份
```{r}
str(wage_data$nr)
str(wage_data$year)
levels(wage_data$nr)
levels(wage_data$year)
```

> factor是代表類別資料的一種class，它可以細分成可排序(ordered)類別（如年份、月份）及不可排序(unordered)類別（如性別）。

4. 請依照<http://stats.idre.ucla.edu/r/modules/factor-variables/>的說明，將year轉成可排序類別變數
```{r}
year.order<-ordered(wage_data$year,levels=c("1980","1981","1982","1983","1984","1985","1986","1987"))
View(year.order)
is.factor(year.order)
```

as.logical(wage_data$union)
> WAGE_data裡有一些變數會隨著時間而改變，比如取對數後的實質薪資($lwage$)、工作經驗($exper$)、婚姻狀況($married$)和工會狀況($union$)。還有一些變數不會隨時間而改變，比如種族($hispan$和$black$)、教育年限($educ$)。

### 初步資料觀察
首先我們看有無加入工會是否會造成薪資的不同。

5. 請將union使用as.logical()轉成logical  class，接著使用geom_boxplot()來繪製比較union=TRUE或FALSE兩群資料的lwage分配箱形圖（如何看請自行Wiki），並描述你的觀察。
```{r}
as.logical(wage_data$union)
library(ggplot2)
wage_data %>% ggplot(aes(x=union&TRUE,y=lwage))+geom_boxplot()
```
The destribution of union&true is more centralize than union&false, and the quartile and mean of union&true are higher than that of union&false. Meanwhile, the maximum and minimum are closer in union&true, that is, join union might help centralize the wage distribution. 

6. 請計算比較不同工會狀況的平均lwage差異[hint: 在作業1中，我們學到使用dplyr::group_by()與dplyr::summarise()來計算不同群組的組內特徵。]
```{r}
wage_data %>% group_by(union) %>% summarise(mean(lwage),sd(lwage))
```

 7. 我們擔心“單純比較不同工會狀態的平均薪資，反應出來的可能不會是單純的工會效果。會不會還包含教育年限的影響？” 請在不做迴歸估計下，單純觀察資料來判斷以上的擔心是否成立。
```{r}
wage_data %>% group_by(educ,union) %>% summarise(mean(lwage)) -> meanlwage
meanlwage %>% ggplot(aes(x=educ,y=`mean(lwage)`,color=union))+geom_point()
```
The worry is correct, higher education would have higher wage. We have to control the effect of education.

8. 將資料依教育年限高低分成≥12與<12兩群(變數取名為educ.high)，使用educ.high與union兩變數，觀察不同教育年限與工會狀態間的平均log薪資差異，並描述你看到的現象（有故事性更好）。[hint: dplyr::group_by()可以放超過一個分類變數，用逗點分隔即可 ]
```{r}
wage_data$educ.high <- wage_data$educ>=12
wage_data$educ.high <- as.numeric(wage_data$educ.high)
wage_data %>% group_by(educ.high,union) %>% summarise(mean(lwage),sd(lwage))
```
This table shows the influence of wage if someone gets higher education or not and joins union or not. the one who earns the highest wage is both getting higher eduction and joining union, holding other factors unchange. And who earns the lowest wage is neither getting higher eduction nor joining union. The effect of getting higher eduction is better than joinin union for higher wage.

### 模型估計
9. 考慮兩個迴歸模型：
$$lwage_{it}	=\beta_{0}+\beta_{1}union_{it}+\epsilon_{it}...(model1)$$
$$lwage_{it}	=\beta_{0}+\beta_{1}union_{it}+\beta_{2}educ.high_{i}+\epsilon_{it}...(model2)$$
個別對兩個模型進行Pooled OLS估計，兩者的$\beta_1$係數估計值有什麼不同？為什麼？[hint: 可以使用stargazer套件，並以指令stargazer(model1,model2,type="text")將估計結果並列呈現以方便比較]
```{r, message=FALSE, warning=FALSE}
model1<- lwage~union
model1 %>% plm(data=wage_data,model="pooling")-> pls1
model2<- lwage~union+educ.high
model2 %>% plm(data=wage_data,model="pooling")-> pls2
library(stargazer)
stargazer(pls1,pls2,type="text")
```
Model2 control both join union and higher eduction. Higher education affects both wage and the decision of union, which we can observe the effect in question 8. Therefore, it's an important factor that should not be omitted.(violate A.3 assumption)

10. 分別計算個別勞動者在樣本期間的平均lwage與平均union，接著畫出兩者間的離散圖及在圖面上加上估計迴歸線。由兩者間的關係，說明勞動者的固定效果如何影響lwage與union兩個變數。
```{r}
wage_data %>% group_by(nr) %>% summarise(mean(lwage),mean(union))-> nrdata
nrdata

nrdata %>% ggplot(aes(x=`mean(union)`,y=`mean(lwage)`))+geom_point()+stat_function(fun=function(x){
  pls1$coefficients[1]+pls1$coefficients[2]*x
  },color="black",linetype="solid")+stat_function(fun=function(x){
  pls2$coefficients[1]+pls2$coefficients[2]*x
  },color="black",linetype="dashed")->f1
f1
```
If we control high education, the slope of model2 is steeper than model1, that is, the effect of joining the union to wage is stronger if he gets higher education. 

11. 對lwage, union及educ.high進行組內demean，並觀察demean後的變數離散度，那一個變數的離散度為零？為什麼？
```{r}
wage_data$lwage_demean <- Within(wage_data$lwage,effect=c("individual"))
wage_data$union_demean <- Within(wage_data$union,effect=c("individual"))
wage_data$educ.high_demean <- Within(wage_data$educ.high,effect=c("individual"))
wage_data %>% ggplot(aes(x=union_demean,y=lwage_demean,color=educ.high_demean))+geom_point()
```
After we demean the factors, we have zero on both union and high education factors. Because I assume both union and high eduction are dummy variables, and they aren't easy to change. The years of  education are almost fixed after someone start to work. And after someone join a union, it is hard to drop out.

12. 考慮如下的模型
$$lwage_{it}=\beta_{1}union_{it}+c_{i}+\epsilon_{it}$$
請分別從固定效果（其估計式有時稱為within estimator）及隨機效果來估算$\beta_1$。
```{r, warning=FALSE}
fe<- plm(model1,data=wage_data,model="within",effect="individual")
re<- plm(model1,data=wage_data,model="random")
stargazer(fe,re,type="text")
```

13. 請檢定固定效果是否與勞動者的工會狀態有關連，並說明適不適合使用隨機效果模型。
```{r}
phtest(fe,re)
```
The p-value is lower than 0.05, so the fixed effect model is related to join union or not. It's not suitable for random effect model.

14. 請檢定是否存在單純與個人特質有關的隨機效果項，並說明適不適合使用Pooled OLS。
```{r}
pls1
pwtest(pls1)
```
There exists random effect factors related to personality.
