---
title: "Part II 電腦作業"
output: html_notebook
---
作業題目有些LaTex數學式，你可以按RStudio上方的Preview來呈現完整的數學符號。

在勞動經濟學中，我們經常關注各種因素對於工資的影響，其中一項是加入工會對於薪資的影響。

首先請先執行以下程式，清空環境並引入Panel分析的套件plm。
```{r, message=FALSE, warning=FALSE}
rm(list=ls())
library(plm)
library(dplyr)
library(ggplot2)
library(psych)
```


1. 引入WAGEPAN.rda這個資料。
```{r}
load("C:/Users/user/Desktop/Part-II-Assignment/WAGEPAN.rdata")
WAGEPAN
```

在WAGEPAN.rda這個資料中，nr代表某個勞動者，year代表資料所來自年份

2. 請定義資料成為panel data，並取名WAGE_data。
(從WAGEPAN中抽取nr,year此兩類資料，進行資料定義與命名)
```{r}
WAGE_data<-pdata.frame(WAGEPAN,c("nr","year"))
```

***
以下分析皆以WAGE_data為主

3. 使用str()檢查nr及year兩個變數的class, 並使用levels()來查看資料橫跨年份
```{r}
str(WAGE_data$nr)
str(WAGE_data$year)
levels(WAGE_data$nr)
levels(WAGE_data$year)
# nr 和 year 都是因子型變數，其中nr有545個，表示這份資料包含了545位勞動者的資料；year
# 為8，表示資料橫跨年度為8年(1980~1987)。

```

> factor是代表類別資料的一種class，它可以細分成可排序(ordered)類別（如年份、月份）及不可排序(unordered)類別（如性別）。

4. 請依照<http://stats.idre.ucla.edu/r/modules/factor-variables/>的說明，將year轉成可排序類別變數
```{r}
WAGE_data$year<-ordered(WAGE_data$year)
levels(WAGE_data$year)
```


> WAGE_data裡有一些變數會隨著時間而改變，比如取對數後的實質薪資($lwage$)、工作經驗($exper$)、婚姻狀況($married$)和工會狀況($union$)。還有一些變數不會隨時間而改變，比如種族($hispan$和$black$)、教育年限($educ$)。

### 初步資料觀察
首先我們看有無加入工會是否會造成薪資的不同。

5. 請將union使用as.logical()轉成logical  class，接著使用geom_boxplot()來繪製比較union=TRUE或FALSE兩群資料的lwage分配箱形圖（如何看請自行Wiki），並描述你的觀察。
```{r}
WAGE_data$union<- as.logical(WAGE_data$union)
class(WAGE_data$union)
WAGE_data %>% ggplot(aes(x=union,y=lwage))+geom_boxplot()
WAGE_data %>% group_by(union)%>%summarise(mean(lwage))

#觀察此兩個箱型圖可發現，加入工會的人其中位數、上四分位數、下四分位數比沒加入工會的人還來得高，且分布更為集中。但最大值變小，最小值變大，個人認為工會確實可以為弱勢族群爭取權益，因此能夠提高最小工資；但參加工會會產生所謂的協商議價成本，導致無法提高最高工資。即工作能力非常強的人可能會選擇不加入工會，獨自與雇主進行協商，欲達到更高的薪資。
```


6. 請計算比較不同工會狀況的平均lwage差異[hint: 在作業1中，我們學到使用dplyr::group_by()與dplyr::summarise()來計算不同群組的組內特徵。]
```{r}
WAGE_data %>% dplyr::group_by(union) %>% dplyr::summarise(mean(lwage),sd(lwage))
```

 7. 我們擔心“單純比較不同工會狀態的平均薪資，反應出來的可能不會是單純的工會效果。會不會還包含教育年限的影響？” 請在不做迴歸估計下，單純觀察資料來判斷以上的擔心是否成立。
```{r}
WAGE_data %>% dplyr::group_by(educ) %>% dplyr::summarise(mean(lwage)) 
# 可以發現教育年限介於3~8年之間，隨著教育年限的增加，平均薪資不一定也是成長，當教育年限介於9~13年之間時，平均薪資才有隨著教育年限的增加而成長。

WAGE_data %>% dplyr::group_by(union,educ) %>% dplyr::summarise(mean(lwage)) -> WAGE.mean
names(WAGE.mean)[3]<-"mlwage"
WAGE.mean %>% ggplot(aes(x=educ,y=mlwage,color=union))+geom_point()
#教育年限為3~9年之間，給定一教育年限，加入工會的平均薪資不一定比較高；但教育年限高於9年時，給定一教育年限，參加工會者的平均薪資會較高，因此接受較高教育者，較有意願參加工會。因此，不同工會狀態的平均薪資，其中可能包含了教育年限的影響。

```

8. 將資料依教育年限高低分成≥12與<12兩群(變數取名為educ.high)，使用educ.high與union兩變數，觀察不同教育年限與工會狀態間的平均log薪資差異，並描述你看到的現象（有故事性更好）。[hint: dplyr::group_by()可以放超過一個分類變數，用逗點分隔即可 ]
```{r}
educ.high<-(WAGE_data$educ>12)
WAGE_data<-cbind(WAGE_data,educ.high)

WAGE_data %>% dplyr::group_by(union,educ.high) %>% dplyr::summarise(mean(lwage))

#首先，不論教育年限高低，加入工會對於增加平均薪資是有利的；不論是否加入工會，教育年限提高，平均薪資亦會上升，即加入工會與提高教育年限對於提高平均薪資而言都是有利的因子。再進行觀察可發現：(1)對於一個教育年限既低又沒有加入工會的人而言，他會選擇再去接受教育(因為1.825632>1.767679)。(2)一位教育年限高的人而言，他可能還是會選擇加入工會，雖然帶來的利益不是太大(1.891460v.s1.825632)
```

### 模型估計
9. 考慮兩個迴歸模型：
$$lwage_{it}	=\beta_{0}+\beta_{1}union_{it}+\epsilon_{it}...(model1)$$
$$lwage_{it}	=\beta_{0}+\beta_{1}union_{it}+\beta_{2}educ.high_{i}+\epsilon_{it}...(model2)$$
個別對兩個模型進行Pooled OLS估計，兩者的$\beta_1$係數估計值有什麼不同？為什麼？[hint: 可以使用stargazer套件，並以指令stargazer(model1,model2,type="text")將估計結果並列呈現以方便比較]
```{r, message=FALSE, warning=FALSE}
library(stargazer)
model1 <- lwage~ union
model2 <- lwage~ union + educ.high

pool1 <- plm(model1, data = WAGE_data, model = "pooling")
pool2 <- plm(model2, data= WAGE_data, model = "pooling")
stargazer(pool1, pool2,type = "text")

#觀察可發現model2的R2大於model1的R2，即model2對於平均薪資擁有較佳的解釋力，教育年限此變數應放入迴歸中一同進行估計。符合第7題所得到的結論--不同工會狀態的平均薪資，其中可能包含了教育年限的影響。
```

10. 分別計算個別勞動者在樣本期間的平均lwage與平均union，接著畫出兩者間的離散圖及在圖面上加上估計迴歸線。由兩者間的關係，說明勞動者的固定效果如何影響lwage與union兩個變數。
```{r}
WAGE_data %>% group_by(nr) %>% summarise_each(funs(mean)) ->id.mean
id1<-lm(model1,data=id.mean)
id2<-lm(model2,data=id.mean)
id.mean %>% ggplot(aes(x=union,y=lwage)) + geom_point()+stat_function(fun=function(x){
  id1$coefficients[1]+id1$coefficients[2]*x
  },color="black",linetype="solid")  + stat_function(fun=function(x){
  id2$coefficients[1]+id2$coefficients[2]*x
  },color="black",linetype="dashed")

#隨著參與工會的年數增加，平均薪資也同樣上升。可特別注意的是，對於都沒有參加工會的人而言，教育年限此固定效果對其造成的效果差異最大。
```


11. 對lwage, union及educ.high進行組內demean，並觀察demean後的變數離散度，那一個變數的離散度為零？為什麼？
```{r}
WAGE_data$lwage_demean<-Within(WAGE_data$lwage,effect=c('individual'))
##  邏輯型變數無法demean，但是就算是轉化為數值型，仍無法demean，不懂如何解決，所以後面用educ demean 沒用educ_high demean
##  WAGE_data$union_demean<-Within(as.numeric(WAGE_data$union),effect=c('individual'))
WAGE_data$educ.high_demean<-Within(WAGE_data$educ,effect=c('individual'))
describe(WAGE_data$educ.high_demean)

#教育年限的離散度為0，因為教育年限並不會在勞動者開始工作後再隨著時間進行改變。而平均薪資與加入工會是否仍會隨著時間有所不同，因此離散度不為零。

```

12. 考慮如下的模型
$$lwage_{it}=\beta_{1}union_{it}+c_{i}+\epsilon_{it}$$
請分別從固定效果（其估計式有時稱為within estimator）及隨機效果來估算$\beta_1$。
```{r, warning=FALSE}
fixid_wage<-plm(model1,data=WAGE_data, model ="within", effect ="individual")
r_wage<-plm(model1,data = WAGE_data, model = "random")
stargazer(fixid_wage,r_wage,type = "text")

```

13. 請檢定固定效果是否與勞動者的工會狀態有關連，並說明適不適合使用隨機效果模型。
```{r}
phtest(fixid_wage,r_wage)

# 進行Hausman test 檢定，而p值小於5%，表示此迴歸具有內生性。可進一步解釋，擔任工具變數角色的教育年限此固定效果與工會狀態(模型內原先就有的解釋變數)兩者相關，所以不適合使用隨機效果模型
```

14. 請檢定是否存在單純與個人特質有關的隨機效果項，並說明適不適合使用Pooled OLS。
```{r}
pool1
pwtest(pool1)

# 若存在與個人特質有關的隨機效果項，則會造成異質變異，因此使用BP test。由 p-value < 2.2e-16、unobserved effect，檢定結果拒絕虛無假設，此模型存在隨機效果項。因此不適合使用要求齊質變異的Pooled OLS。
```